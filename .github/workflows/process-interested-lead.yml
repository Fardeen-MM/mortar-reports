name: Process Interested Lead

on:
  repository_dispatch:
    types: [interested_lead]

jobs:
  research-and-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Cache dependencies and Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            automation/node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-deps-${{ hashFiles('automation/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-
          
      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium
        working-directory: ./automation
        
      - name: Extract lead data
        id: lead_data
        run: |
          echo "lead_email=${{ github.event.client_payload.email }}" >> $GITHUB_OUTPUT
          echo "email_id=${{ github.event.client_payload.email_id }}" >> $GITHUB_OUTPUT
          echo "from_email=${{ github.event.client_payload.from_email }}" >> $GITHUB_OUTPUT
          
      - name: Parse website from lead data
        id: parse
        run: |
          # Extract ALL fields from Instantly
          WEBSITE="${{ github.event.client_payload.website }}"
          CONTACT_NAME="${{ github.event.client_payload.first_name }} ${{ github.event.client_payload.last_name }}"
          CITY="${{ github.event.client_payload.city }}"
          STATE="${{ github.event.client_payload.state }}"
          COUNTRY="${{ github.event.client_payload.country }}"
          COMPANY="${{ github.event.client_payload.company }}"
          
          # If no website in payload, we'll need to extract from email domain
          if [ -z "$WEBSITE" ]; then
            DOMAIN=$(echo "${{ github.event.client_payload.email }}" | cut -d'@' -f2)
            WEBSITE="https://www.$DOMAIN"
          fi
          
          # Generate slug from website
          SLUG=$(echo "$WEBSITE" | sed 's/https:\/\///' | sed 's/http:\/\///' | sed 's/www\.//' | sed 's/\..*//')
          
          echo "website=$WEBSITE" >> $GITHUB_OUTPUT
          echo "contact_name=$CONTACT_NAME" >> $GITHUB_OUTPUT
          echo "city=$CITY" >> $GITHUB_OUTPUT
          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "country=$COUNTRY" >> $GITHUB_OUTPUT
          echo "company=$COMPANY" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
      
      - name: Create reports directory
        run: mkdir -p reports
        working-directory: ./automation
          
      - name: Run research script (AI Firm Intelligence)
        id: research
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC }}
        run: |
          node law-firm-research.js \
            "${{ steps.parse.outputs.website }}" \
            "${{ steps.parse.outputs.contact_name }}" \
            "${{ steps.parse.outputs.city }}" \
            "${{ steps.parse.outputs.state }}" \
            "${{ steps.parse.outputs.country }}" \
            "${{ steps.parse.outputs.company }}"
        working-directory: ./automation
        
      - name: AI-powered analysis
        id: ai_analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC }}
        run: |
          REPORT_FILE=$(find reports -name "*-intel-v5.json" -o -name "*-research.json" -type f | head -1)
          if [ -z "$REPORT_FILE" ]; then
            echo "Error: No research JSON found"
            exit 1
          fi
          echo "Found report: $REPORT_FILE"
          node ai-analyzer.js "$REPORT_FILE"
        working-directory: ./automation
        
      - name: Normalize research data for report generator
        run: |
          REPORT_FILE=$(find reports -name "*-intel-v5.json" -o -name "*-research.json" -type f | head -1)
          if [ -z "$REPORT_FILE" ]; then
            echo "Error: No research JSON found"
            exit 1
          fi
          echo "ðŸ“Š Normalizing: $REPORT_FILE"
          echo "ðŸ“„ BEFORE normalize - competitors:"
          cat "$REPORT_FILE" | jq -r '.competitors // [] | length'
          node normalize-research-data.js "$REPORT_FILE"
          echo "ðŸ“„ AFTER normalize - competitors:"
          cat "$REPORT_FILE" | jq -r '.competitors // [] | length'
          echo "ðŸ“„ AFTER normalize - has gaps:"
          cat "$REPORT_FILE" | jq 'has("gaps")'
        working-directory: ./automation
      
      - name: Debug V11 Environment
        run: |
          echo "=== V11 DEBUG INFO ==="
          echo "Node: $(node --version)"
          echo ""
          echo "V11 files:"
          ls -lh report-generator-v11.js report-v9-css.js
          echo ""
          REPORT_FILE=$(find reports -name "*-intel-v5.json" -o -name "*-research.json" -type f | head -1)
          echo "Research file: $REPORT_FILE"
          echo "Contact name: ${{ steps.parse.outputs.contact_name }}"
          echo ""
          echo "Testing module load:"
          node -e "require('./report-generator-v11.js'); console.log('âœ… V11 loads')" || echo "âŒ V11 load failed"
          node -e "const c=require('./report-v9-css.js'); c(); console.log('âœ… CSS loads')" || echo "âŒ CSS load failed"
          echo ""
          echo "Data structure:"
          node -e "const d=require('./$REPORT_FILE'); console.log('Firm:', d.firmName); console.log('Loc:', d.location?.city, d.location?.state); console.log('Comps:', d.competitors?.length || 0); console.log('Gaps:', Array.isArray(d.gaps) ? 'array['+d.gaps.length+']' : typeof d.gaps);"
        working-directory: ./automation
        
      - name: Generate report with AI insights (V11 - 7 Critical Fixes)
        id: report
        run: |
          REPORT_FILE=$(find reports -name "*-intel-v5.json" -o -name "*-research.json" -type f | head -1)
          if [ -z "$REPORT_FILE" ]; then
            echo "Error: No research JSON found"
            exit 1
          fi
          echo "ðŸ“„ Generating report from: $REPORT_FILE"
          echo "ðŸ“„ V11 INPUT - competitors:"
          cat "$REPORT_FILE" | jq -r '.competitors // [] | length'
          echo "ðŸ“„ V11 INPUT - has gaps:"
          cat "$REPORT_FILE" | jq 'has("gaps")'
          node report-generator-v11.js "$REPORT_FILE" "${{ steps.parse.outputs.contact_name }}" 2>&1 || {
            echo "âŒ Generation failed with exit code: $?"
            echo "Checking for generation-blocked.json:"
            cat generation-blocked.json 2>/dev/null || echo "No generation-blocked.json found"
            exit 1
          }
        working-directory: ./automation
        
      - name: Quality Control & Iterative Fixing (AI-Powered)
        id: qc
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC }}
        run: |
          REPORT_JSON=$(find reports -name "*-intel-v5.json" -o -name "*-research.json" -type f | head -1)
          REPORT_HTML=$(find reports -name "*-landing-page-v11.html" -type f | head -1)
          CONTACT_NAME="${{ steps.parse.outputs.contact_name }}"
          
          echo "ðŸ”„ Starting iterative QC system..."
          echo "Research: $REPORT_JSON"
          echo "Report: $REPORT_HTML"
          echo ""
          
          # Run iterative QC (handles validation, AI analysis, regeneration, looping)
          if node iterative-qc.js "$REPORT_JSON" "$REPORT_HTML" "$CONTACT_NAME"; then
            echo "âœ… QC PASSED - Report is perfect!"
            echo "qc_passed=true" >> $GITHUB_OUTPUT
            
            # Read iteration count from result
            ITERATIONS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('iterative-qc-result.json', 'utf8')).iterations)")
            echo "iterations=$ITERATIONS" >> $GITHUB_OUTPUT
          else
            echo "âŒ QC FAILED after 5 iterations"
            echo "qc_passed=false" >> $GITHUB_OUTPUT
            echo "iterations=5" >> $GITHUB_OUTPUT
            
            # Read issues from result for Telegram notification
            node -e "
              const result = JSON.parse(require('fs').readFileSync('iterative-qc-result.json', 'utf8'));
              console.log('\\nðŸš¨ UNRESOLVED ISSUES:');
              Object.entries(result.byPhase || {}).forEach(([phase, issues]) => {
                console.log(\`\\n\${phase}:\`);
                issues.forEach(issue => console.log(\`  - \${issue}\`));
              });
            "
          fi
        working-directory: ./automation
        
      - name: Log QC Results
        run: |
          if [ "${{ steps.qc.outputs.qc_passed }}" = "true" ]; then
            echo "âœ… QC passed after ${{ steps.qc.outputs.iterations }} iteration(s)"
          else
            echo "âš ï¸  QC failed after ${{ steps.qc.outputs.iterations }} iteration(s)"
            echo "Report deployed with warnings for manual review"
          fi
        
      - name: Deploy report to GitHub Pages
        run: |
          # Get the research JSON to extract firm name
          REPORT_JSON=$(find automation/reports -name "*-intel-v5.json" -o -name "*-research.json" -type f | head -1)
          
          # Extract firm name from JSON and create clean folder name
          # Remove spaces, special chars, convert to PascalCase
          FIRM_NAME=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('$REPORT_JSON', 'utf8'));
            const name = data.firmName || data.title || 'UnknownFirm';
            // Clean: remove non-alphanumeric except spaces, then PascalCase
            const clean = name
              .replace(/[^a-zA-Z0-9\\s&]/g, '')
              .split(/\\s+/)
              .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
              .join('');
            console.log(clean);
          ")
          
          echo "Creating folder: $FIRM_NAME"
          
          # Create firm folder at root level (not inside reports/)
          mkdir -p "$FIRM_NAME"
          
          # Copy generated HTML as index.html
          REPORT_HTML=$(find automation/reports -name "*-landing-page-v11.html" -type f | head -1)
          if [ -z "$REPORT_HTML" ]; then
            REPORT_HTML=$(find automation/reports -name "*.html" -type f | head -1)
          fi
          
          if [ -z "$REPORT_HTML" ]; then
            echo "âŒ Error: No HTML report found in automation/reports/"
            ls -la automation/reports/
            exit 1
          fi
          
          echo "ðŸ“„ Found report: $REPORT_HTML"
          cp "$REPORT_HTML" "$FIRM_NAME/index.html"
          
          # Save for next step (will push after creating approval JSON)
          echo "firm_folder=$FIRM_NAME" >> $GITHUB_OUTPUT
        id: deploy
          
      - name: Send Telegram approval request
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REPORT_URL="https://reports.mortarmetrics.com/${{ steps.deploy.outputs.firm_folder }}/"
          
          # Extract original firm name from research JSON (for file lookup)
          REPORT_JSON=$(find reports -name "*-intel-v5.json" -o -name "*-research.json" -type f | head -1)
          ORIGINAL_FIRM_NAME=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('$REPORT_JSON', 'utf8'));
            console.log(data.firmName || data.title || '${{ steps.deploy.outputs.firm_folder }}');
          ")
          
          mkdir -p pending-approvals
          
          # Create approval data file
          cat > "pending-approvals/${{ steps.deploy.outputs.firm_folder }}.json" << EOF
          {
            "firm_name": "$ORIGINAL_FIRM_NAME",
            "firm_folder": "${{ steps.deploy.outputs.firm_folder }}",
            "lead_email": "${{ steps.lead_data.outputs.lead_email }}",
            "contact_name": "${{ steps.parse.outputs.contact_name }}",
            "report_url": "$REPORT_URL",
            "email_id": "${{ steps.lead_data.outputs.email_id }}",
            "from_email": "${{ steps.lead_data.outputs.from_email }}",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "pending_approval"
          }
          EOF
          
          # Send to Telegram
          node telegram-approval-bot.js "pending-approvals/${{ steps.deploy.outputs.firm_folder }}.json"
          
          echo "âœ… Telegram approval request sent for ${{ steps.deploy.outputs.firm_folder }}"
        working-directory: ./automation
        
      - name: Commit and push report + approval (single push)
        run: |
          FIRM_FOLDER="${{ steps.deploy.outputs.firm_folder }}"
          
          # Configure git
          git config user.name "Mortar Metrics Bot"
          git config user.email "automation@mortarmetrics.com"
          
          # Pull latest changes first to avoid conflicts
          git pull --rebase origin main || echo "âš ï¸  No upstream changes to pull"
          
          # Stage both report and approval JSON
          git add "$FIRM_FOLDER/index.html"
          git add "automation/pending-approvals/$FIRM_FOLDER.json"
          
          # Single commit for both files
          git commit -m "Add report and approval for $FIRM_FOLDER" || echo "âš ï¸  No changes to commit"
          
          # Single push (triggers only 1 Pages build)
          git push origin main || {
            echo "âš ï¸  Push failed, pulling and retrying..."
            git pull --rebase origin main
            git push origin main
          }
          
          echo "âœ… Pushed report and approval in single commit"
