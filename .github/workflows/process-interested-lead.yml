name: Process Interested Lead

on:
  repository_dispatch:
    types: [interested_lead]

jobs:
  research-and-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install playwright
          npx playwright install chromium
          npm install
        working-directory: ./automation
        
      - name: Extract lead data
        id: lead_data
        run: |
          echo "lead_email=${{ github.event.client_payload.email }}" >> $GITHUB_OUTPUT
          echo "email_id=${{ github.event.client_payload.email_id }}" >> $GITHUB_OUTPUT
          
      - name: Parse website from lead data
        id: parse
        run: |
          # Extract website from custom fields or use a default
          WEBSITE="${{ github.event.client_payload.website }}"
          CONTACT_NAME="${{ github.event.client_payload.first_name }} ${{ github.event.client_payload.last_name }}"
          
          # If no website in payload, we'll need to extract from email domain
          if [ -z "$WEBSITE" ]; then
            DOMAIN=$(echo "${{ github.event.client_payload.email }}" | cut -d'@' -f2)
            WEBSITE="https://www.$DOMAIN"
          fi
          
          # Generate slug from website
          SLUG=$(echo "$WEBSITE" | sed 's/https:\/\///' | sed 's/http:\/\///' | sed 's/www\.//' | sed 's/\..*//')
          
          echo "website=$WEBSITE" >> $GITHUB_OUTPUT
          echo "contact_name=$CONTACT_NAME" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
      
      - name: Create reports directory
        run: mkdir -p reports
        working-directory: ./automation
          
      - name: Run research script
        id: research
        run: |
          node research-v3-DEEP.js "${{ steps.parse.outputs.website }}" "${{ steps.parse.outputs.contact_name }}"
        working-directory: ./automation
        
      - name: AI-powered analysis
        id: ai_analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC }}
        run: |
          REPORT_FILE=$(find reports -name "*-research.json" -type f | head -1)
          if [ -z "$REPORT_FILE" ]; then
            echo "Error: No research JSON found"
            exit 1
          fi
          echo "Found report: $REPORT_FILE"
          node ai-analyzer.js "$REPORT_FILE"
        working-directory: ./automation
        
      - name: Generate report with AI insights
        id: report
        run: |
          REPORT_FILE=$(find reports -name "*-research.json" -type f | head -1)
          if [ -z "$REPORT_FILE" ]; then
            echo "Error: No research JSON found"
            exit 1
          fi
          echo "Found report: $REPORT_FILE"
          node report-generator-v7.js "$REPORT_FILE" "${{ steps.parse.outputs.contact_name }}"
          
          # Inject AI insights into generated HTML
          REPORT_HTML=$(find reports -name "*-landing-page-v7.html" -type f | head -1)
          if [ -n "$REPORT_HTML" ]; then
            echo "Injecting AI insights into: $REPORT_HTML"
            node inject-ai-insights.js "$REPORT_HTML" "$REPORT_FILE"
          fi
        working-directory: ./automation
        
      - name: Deploy report to GitHub Pages
        run: |
          # Get the research JSON to extract firm name
          REPORT_JSON=$(find automation/reports -name "*-research.json" -type f | head -1)
          
          # Extract firm name from JSON and create clean folder name
          # Remove spaces, special chars, convert to PascalCase
          FIRM_NAME=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('$REPORT_JSON', 'utf8'));
            const name = data.firmName || data.title || 'UnknownFirm';
            // Clean: remove non-alphanumeric except spaces, then PascalCase
            const clean = name
              .replace(/[^a-zA-Z0-9\\s&]/g, '')
              .split(/\\s+/)
              .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
              .join('');
            console.log(clean);
          ")
          
          echo "Creating folder: $FIRM_NAME"
          
          # Create firm folder at root level (not inside reports/)
          mkdir -p "$FIRM_NAME"
          
          # Copy generated HTML as index.html
          REPORT_HTML=$(ls automation/reports/*-landing-page-v8.html 2>/dev/null || ls automation/reports/*-landing-page-v7.html 2>/dev/null || ls automation/reports/*-report.html | tail -1)
          cp "$REPORT_HTML" "$FIRM_NAME/index.html"
          
          # Commit and push
          git config user.name "Mortar Metrics Bot"
          git config user.email "automation@mortarmetrics.com"
          git add "$FIRM_NAME/index.html"
          git commit -m "Add report for $FIRM_NAME"
          git push
          
          # Save for email step
          echo "firm_folder=$FIRM_NAME" >> $GITHUB_OUTPUT
        id: deploy
          
      - name: Send follow-up email via Instantly (reply in same thread)
        env:
          INSTANTLY_API_KEY: ${{ secrets.INSTANTLY_API_KEY }}
        run: |
          REPORT_URL="https://reports.mortarmetrics.com/${{ steps.deploy.outputs.firm_folder }}/"
          EMAIL_ID="${{ steps.lead_data.outputs.email_id }}"
          
          node send-email.js \
            "${{ steps.lead_data.outputs.lead_email }}" \
            "${{ steps.parse.outputs.contact_name }}" \
            "$REPORT_URL" \
            "$EMAIL_ID"
        working-directory: ./automation
        
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          REPORT_URL="https://reports.mortarmetrics.com/${{ steps.deploy.outputs.firm_folder }}/"
          
          if [ "$STATUS" = "success" ]; then
            MESSAGE="‚úÖ Report generated for *${{ steps.parse.outputs.contact_name }}*\nüìß Email: ${{ steps.lead_data.outputs.lead_email }}\nüîó Report: $REPORT_URL"
          else
            MESSAGE="‚ùå Failed to generate report for ${{ steps.lead_data.outputs.lead_email }}"
          fi
          
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"$MESSAGE\"}"
