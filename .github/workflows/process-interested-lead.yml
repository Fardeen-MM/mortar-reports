name: Process Interested Lead

on:
  repository_dispatch:
    types: [interested_lead]

jobs:
  research-and-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Cache dependencies and Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            automation/node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-deps-${{ hashFiles('automation/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-
          
      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium
        working-directory: ./automation
        
      - name: Extract lead data
        id: lead_data
        run: |
          echo "lead_email=${{ github.event.client_payload.email }}" >> $GITHUB_OUTPUT
          echo "email_id=${{ github.event.client_payload.email_id }}" >> $GITHUB_OUTPUT
          echo "from_email=${{ github.event.client_payload.from_email }}" >> $GITHUB_OUTPUT
          
      - name: Debug - Show ALL webhook data
        run: |
          echo "========================================="
          echo "ALL FIELDS FROM INSTANTLY WEBHOOK:"
          echo "========================================="
          echo '${{ toJSON(github.event.client_payload) }}' | jq '.'
          echo "========================================="
          
      - name: Parse website from lead data
        id: parse
        run: |
          # Extract ALL fields from Instantly
          WEBSITE="${{ github.event.client_payload.website }}"
          FIRST_NAME="${{ github.event.client_payload.first_name }}"
          LAST_NAME="${{ github.event.client_payload.last_name }}"
          CITY="${{ github.event.client_payload.city }}"
          STATE="${{ github.event.client_payload.state }}"
          COUNTRY="${{ github.event.client_payload.country }}"
          COMPANY="${{ github.event.client_payload.company }}"
          
          echo "Extracted values:"
          echo "  website: $WEBSITE"
          echo "  first_name: $FIRST_NAME"
          echo "  last_name: $LAST_NAME"
          echo "  city: $CITY"
          echo "  state: $STATE"
          echo "  country: $COUNTRY"
          echo "  company: $COMPANY"
          
          # Build contact name only if both first and last are non-empty
          CONTACT_NAME=""
          if [ -n "$FIRST_NAME" ] && [ -n "$LAST_NAME" ]; then
            CONTACT_NAME="$FIRST_NAME $LAST_NAME"
          elif [ -n "$FIRST_NAME" ]; then
            CONTACT_NAME="$FIRST_NAME"
          fi
          
          # If no website in payload, extract from email domain
          if [ -z "$WEBSITE" ]; then
            DOMAIN=$(echo "${{ github.event.client_payload.email }}" | cut -d'@' -f2)
            WEBSITE="https://www.$DOMAIN"
          fi
          
          # Generate slug from website
          SLUG=$(echo "$WEBSITE" | sed 's/https:\/\///' | sed 's/http:\/\///' | sed 's/www\.//' | sed 's/\..*//')
          
          echo "website=$WEBSITE" >> $GITHUB_OUTPUT
          echo "contact_name=$CONTACT_NAME" >> $GITHUB_OUTPUT
          echo "city=$CITY" >> $GITHUB_OUTPUT
          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "country=$COUNTRY" >> $GITHUB_OUTPUT
          echo "company=$COMPANY" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
      
      - name: Create reports directory
        run: mkdir -p reports
        working-directory: ./automation
          
      - name: Run Maximal Research Engine V2
        id: research
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC }}
        run: |
          node maximal-research-v2.js \
            "${{ steps.parse.outputs.website }}" \
            "${{ steps.parse.outputs.contact_name }}" \
            "${{ steps.parse.outputs.city }}" \
            "${{ steps.parse.outputs.state }}" \
            "${{ steps.parse.outputs.country }}" \
            "${{ steps.parse.outputs.company }}"
        working-directory: ./automation
        timeout-minutes: 10
        
      - name: Extract firm info from research
        id: extract
        run: |
          RESEARCH_FILE=$(find reports -name "*-maximal-research.json" -type f | head -1)
          
          if [ -z "$RESEARCH_FILE" ]; then
            echo "Error: No research JSON found"
            exit 1
          fi
          
          # Extract firm name from research
          FIRM_NAME=$(node -e "
            const data = JSON.parse(require('fs').readFileSync('$RESEARCH_FILE', 'utf8'));
            console.log(data.firmName || 'Unknown Firm');
          ")
          
          # Extract contact name from research or email (NEW: check extracted team data first)
          CONTACT_NAME="${{ steps.parse.outputs.contact_name }}"
          if [ -z "$CONTACT_NAME" ] || [ "$CONTACT_NAME" = " " ]; then
            # Try multiple sources in order of preference
            CONTACT_NAME=$(node -e "
              const data = JSON.parse(require('fs').readFileSync('$RESEARCH_FILE', 'utf8'));
              
              // 1. Founding partners (most likely decision maker)
              if (data.team?.foundingPartners?.[0]?.name) {
                console.log(data.team.foundingPartners[0].name);
                process.exit(0);
              }
              
              // 2. Leadership
              if (data.team?.leadership?.name) {
                console.log(data.team.leadership.name);
                process.exit(0);
              }
              
              // 3. Key attorneys
              if (data.team?.keyAttorneys?.[0]?.name) {
                console.log(data.team.keyAttorneys[0].name);
                process.exit(0);
              }
              
              // 4. Old intelligence structure
              if (data.intelligence?.keyDecisionMakers?.[0]?.name) {
                console.log(data.intelligence.keyDecisionMakers[0].name);
                process.exit(0);
              }
              
              // 5. Extract from email (smart - avoid generic addresses)
              const email = '${{ steps.lead_data.outputs.lead_email }}';
              if (email && email.includes('@')) {
                const localPart = email.split('@')[0].toLowerCase();
                
                // Skip generic addresses
                if (['info', 'contact', 'admin', 'office', 'support', 'hello', 'mail'].includes(localPart)) {
                  console.log('Partner');
                  process.exit(0);
                }
                
                const name = localPart
                  .replace(/[._-]/g, ' ')
                  .split(' ')
                  .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                  .join(' ');
                console.log(name || 'Partner');
              } else {
                console.log('Partner');
              }
            ")
          fi
          
          echo "firm_name=$FIRM_NAME" >> $GITHUB_OUTPUT
          echo "contact_name=$CONTACT_NAME" >> $GITHUB_OUTPUT
        working-directory: ./automation
        
      - name: Generate V12 Hybrid Report
        id: report
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC }}
        run: |
          RESEARCH_FILE=$(find reports -name "*-maximal-research.json" -type f | head -1)
          if [ -z "$RESEARCH_FILE" ]; then
            echo "Error: No research JSON found"
            exit 1
          fi
          echo "Generating report for: ${{ steps.extract.outputs.firm_name }}"
          echo "Contact: ${{ steps.extract.outputs.contact_name }}"
          node report-generator-v12-hybrid.js "$RESEARCH_FILE" "${{ steps.extract.outputs.contact_name }}"
        working-directory: ./automation
        timeout-minutes: 5
        
      - name: Deploy report to GitHub Pages
        run: |
          # Use extracted firm name from research
          RAW_FIRM_NAME="${{ steps.extract.outputs.firm_name }}"
          
          # Clean firm name for folder (PascalCase, no special chars except &)
          FIRM_FOLDER=$(node -e "
            const name = '$RAW_FIRM_NAME';
            const clean = name
              .replace(/[^a-zA-Z0-9\\s&]/g, '')
              .split(/\\s+/)
              .filter(w => w.length > 0)
              .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
              .join('');
            console.log(clean || 'UnknownFirm');
          ")
          
          echo "Creating folder: $FIRM_FOLDER for $RAW_FIRM_NAME"
          mkdir -p "$FIRM_FOLDER"
          
          REPORT_HTML=$(find automation/reports -name "*-landing-page-v12-hybrid.html" -type f | head -1)
          if [ -z "$REPORT_HTML" ]; then
            echo "Error: No V12 Hybrid HTML found"
            exit 1
          fi
          
          cp "$REPORT_HTML" "$FIRM_FOLDER/index.html"
          echo "firm_folder=$FIRM_FOLDER" >> $GITHUB_OUTPUT
          echo "firm_name=$RAW_FIRM_NAME" >> $GITHUB_OUTPUT
        id: deploy
          
      - name: Send Telegram approval request
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REPORT_URL="https://reports.mortarmetrics.com/${{ steps.deploy.outputs.firm_folder }}/"
          FIRM_NAME="${{ steps.deploy.outputs.firm_name }}"
          CONTACT_NAME="${{ steps.extract.outputs.contact_name }}"
          
          mkdir -p pending-approvals
          cat > "pending-approvals/${{ steps.deploy.outputs.firm_folder }}.json" << EOF
          {
            "firm_name": "$FIRM_NAME",
            "firm_folder": "${{ steps.deploy.outputs.firm_folder }}",
            "lead_email": "${{ steps.lead_data.outputs.lead_email }}",
            "contact_name": "$CONTACT_NAME",
            "report_url": "$REPORT_URL",
            "email_id": "${{ steps.lead_data.outputs.email_id }}",
            "from_email": "${{ steps.lead_data.outputs.from_email }}",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "pending_approval",
            "report_version": "V12-AI"
          }
          EOF
          
          echo "Sending Telegram approval for $FIRM_NAME (contact: $CONTACT_NAME)"
          node telegram-approval-bot.js "pending-approvals/${{ steps.deploy.outputs.firm_folder }}.json"
        working-directory: ./automation
        
      - name: Commit and push report
        run: |
          FIRM_FOLDER="${{ steps.deploy.outputs.firm_folder }}"
          git config user.name "Mortar Metrics Bot"
          git config user.email "automation@mortarmetrics.com"
          git pull --rebase origin main || echo "No upstream changes"
          git add "$FIRM_FOLDER/index.html"
          git add "automation/pending-approvals/$FIRM_FOLDER.json"
          git commit -m "Add V12 AI report for $FIRM_FOLDER" || echo "No changes"
          git push origin main || {
            git pull --rebase origin main
            git push origin main
          }
