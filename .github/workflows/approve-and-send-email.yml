name: Approve and Send Email

on:
  workflow_dispatch:
    inputs:
      firm_name:
        description: 'Firm Name'
        required: true
      lead_email:
        description: 'Lead Email'
        required: true
      report_url:
        description: 'Report URL'
        required: true
      email_id:
        description: 'Instantly Email ID (for threading)'
        required: false
      contact_name:
        description: 'Contact Name'
        required: true
      from_email:
        description: 'From Email (sending account)'
        required: false
        default: 'fardeen@mortarmetrics.com'
  repository_dispatch:
    types: [send_approved_email]

jobs:
  send-approved-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        working-directory: ./automation
        
      - name: Extract inputs
        id: inputs
        run: |
          # Handle both workflow_dispatch and repository_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "firm_name=${{ github.event.inputs.firm_name }}" >> $GITHUB_OUTPUT
            echo "lead_email=${{ github.event.inputs.lead_email }}" >> $GITHUB_OUTPUT
            echo "contact_name=${{ github.event.inputs.contact_name }}" >> $GITHUB_OUTPUT
            echo "report_url=${{ github.event.inputs.report_url }}" >> $GITHUB_OUTPUT
            echo "email_id=${{ github.event.inputs.email_id }}" >> $GITHUB_OUTPUT
            echo "from_email=${{ github.event.inputs.from_email }}" >> $GITHUB_OUTPUT
          else
            # repository_dispatch (from Telegram)
            echo "firm_name=${{ github.event.client_payload.firm_name }}" >> $GITHUB_OUTPUT
            echo "lead_email=${{ github.event.client_payload.lead_email }}" >> $GITHUB_OUTPUT
            echo "contact_name=${{ github.event.client_payload.contact_name }}" >> $GITHUB_OUTPUT
            echo "report_url=${{ github.event.client_payload.report_url }}" >> $GITHUB_OUTPUT
            echo "email_id=${{ github.event.client_payload.email_id }}" >> $GITHUB_OUTPUT
            echo "from_email=${{ github.event.client_payload.from_email }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy report from pending to live
        id: deploy
        run: |
          FIRM_NAME="${{ steps.inputs.outputs.firm_name }}"

          # Generate folder name from firm name (same logic as process workflow)
          FIRM_FOLDER=$(node -e "
            const name = '$FIRM_NAME';
            const clean = name
              .replace(/[^a-zA-Z0-9\\s&]/g, '')
              .split(/\\s+/)
              .filter(w => w.length > 0)
              .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
              .join('');
            console.log(clean || 'UnknownFirm');
          ")

          echo "firm_folder=$FIRM_FOLDER" >> $GITHUB_OUTPUT

          # Check if pending report exists
          if [ -f "pending-reports/$FIRM_FOLDER/index.html" ]; then
            echo "ğŸ“‚ Moving report from pending-reports/$FIRM_FOLDER to $FIRM_FOLDER (LIVE)"
            mkdir -p "$FIRM_FOLDER"
            mv "pending-reports/$FIRM_FOLDER/index.html" "$FIRM_FOLDER/index.html"
            rmdir "pending-reports/$FIRM_FOLDER" 2>/dev/null || true

            # Update approval status
            if [ -f "automation/pending-approvals/$FIRM_FOLDER.json" ]; then
              # Update status to approved
              node -e "
                const fs = require('fs');
                const file = 'automation/pending-approvals/$FIRM_FOLDER.json';
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                data.status = 'approved';
                data.approved_at = new Date().toISOString();
                fs.writeFileSync(file, JSON.stringify(data, null, 2));
              "
            fi
          else
            echo "âš ï¸  No pending report found at pending-reports/$FIRM_FOLDER"
            echo "   Report may have already been deployed or path is different"
            # Check if live report exists already
            if [ -f "$FIRM_FOLDER/index.html" ]; then
              echo "   Live report already exists - continuing with email"
            fi
          fi

      - name: Commit and push live report
        run: |
          FIRM_FOLDER="${{ steps.deploy.outputs.firm_folder }}"
          git config user.name "Mortar Metrics Bot"
          git config user.email "automation@mortarmetrics.com"
          git pull --rebase origin main || echo "No upstream changes"

          # Add live folder and updated approval status
          git add "$FIRM_FOLDER/" 2>/dev/null || true
          git add "automation/pending-approvals/$FIRM_FOLDER.json" 2>/dev/null || true
          git add "pending-reports/" 2>/dev/null || true
          git commit -m "Deploy approved report for $FIRM_FOLDER" || echo "No changes to commit"
          git push origin main || {
            git pull --rebase origin main
            git push origin main
          }

      - name: Send approved email
        env:
          INSTANTLY_API_KEY: ${{ secrets.INSTANTLY_API_KEY }}
        run: |
          echo "ğŸ“§ Sending approved email to ${{ steps.inputs.outputs.lead_email }}"
          echo "ğŸ¢ Firm: ${{ steps.inputs.outputs.firm_name }}"
          echo "ğŸ“¨ From: ${{ steps.inputs.outputs.from_email }}"
          echo "ğŸ”— Report: ${{ steps.inputs.outputs.report_url }}"

          node send-email.js \
            "${{ steps.inputs.outputs.lead_email }}" \
            "${{ steps.inputs.outputs.contact_name }}" \
            "${{ steps.inputs.outputs.report_url }}" \
            "${{ steps.inputs.outputs.email_id }}" \
            "${{ steps.inputs.outputs.firm_name }}" \
            "${{ steps.inputs.outputs.from_email }}"
        working-directory: ./automation
