name: Approve and Send Email

on:
  workflow_dispatch:
    inputs:
      firm_name:
        description: 'Firm Name'
        required: true
      lead_email:
        description: 'Lead Email'
        required: true
      report_url:
        description: 'Report URL'
        required: true
      contact_name:
        description: 'Contact Name'
        required: true
  repository_dispatch:
    types: [send_approved_email]

jobs:
  send-approved-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        working-directory: ./automation
        
      - name: Extract inputs
        id: inputs
        env:
          EVENT_NAME: ${{ github.event_name }}
          # workflow_dispatch inputs
          WD_FIRM_NAME: ${{ github.event.inputs.firm_name }}
          WD_LEAD_EMAIL: ${{ github.event.inputs.lead_email }}
          WD_CONTACT_NAME: ${{ github.event.inputs.contact_name }}
          WD_REPORT_URL: ${{ github.event.inputs.report_url }}
          # repository_dispatch payload
          RD_FIRM_NAME: ${{ github.event.client_payload.firm_name }}
          RD_FIRM_FOLDER: ${{ github.event.client_payload.firm_folder }}
          RD_LEAD_EMAIL: ${{ github.event.client_payload.lead_email }}
          RD_CONTACT_NAME: ${{ github.event.client_payload.contact_name }}
          RD_REPORT_URL: ${{ github.event.client_payload.report_url }}
          RD_TOTAL_RANGE: ${{ github.event.client_payload.total_range }}
          RD_TOTAL_CASES: ${{ github.event.client_payload.total_cases }}
          RD_PRACTICE_LABEL: ${{ github.event.client_payload.practice_label }}
          RD_COUNTRY: ${{ github.event.client_payload.country }}
          RD_SKIP_EMAIL: ${{ github.event.client_payload.skip_email }}
        run: |
          # Handle both workflow_dispatch and repository_dispatch
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "firm_name=$WD_FIRM_NAME" >> $GITHUB_OUTPUT
            echo "lead_email=$WD_LEAD_EMAIL" >> $GITHUB_OUTPUT
            echo "contact_name=$WD_CONTACT_NAME" >> $GITHUB_OUTPUT
            echo "report_url=$WD_REPORT_URL" >> $GITHUB_OUTPUT
            echo "firm_folder=" >> $GITHUB_OUTPUT
            echo "total_range=" >> $GITHUB_OUTPUT
            echo "total_cases=" >> $GITHUB_OUTPUT
            echo "practice_label=" >> $GITHUB_OUTPUT
            echo "country=" >> $GITHUB_OUTPUT
            echo "skip_email=" >> $GITHUB_OUTPUT
          else
            # repository_dispatch (from Telegram webhook)
            echo "firm_name=$RD_FIRM_NAME" >> $GITHUB_OUTPUT
            echo "firm_folder=$RD_FIRM_FOLDER" >> $GITHUB_OUTPUT
            echo "lead_email=$RD_LEAD_EMAIL" >> $GITHUB_OUTPUT
            echo "contact_name=$RD_CONTACT_NAME" >> $GITHUB_OUTPUT
            echo "report_url=$RD_REPORT_URL" >> $GITHUB_OUTPUT
            echo "total_range=$RD_TOTAL_RANGE" >> $GITHUB_OUTPUT
            echo "total_cases=$RD_TOTAL_CASES" >> $GITHUB_OUTPUT
            echo "practice_label=$RD_PRACTICE_LABEL" >> $GITHUB_OUTPUT
            echo "country=$RD_COUNTRY" >> $GITHUB_OUTPUT
            echo "skip_email=$RD_SKIP_EMAIL" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy report from pending to live
        id: deploy
        run: |
          FIRM_NAME="${{ steps.inputs.outputs.firm_name }}"
          INPUT_FIRM_FOLDER="${{ steps.inputs.outputs.firm_folder }}"

          # Use firm_folder if provided, otherwise generate from firm name
          if [ -n "$INPUT_FIRM_FOLDER" ]; then
            FIRM_FOLDER="$INPUT_FIRM_FOLDER"
            echo "Using provided firm_folder: $FIRM_FOLDER"
          else
            # Generate folder name from firm name (same logic as process workflow)
            FIRM_FOLDER=$(node -e "
              const name = '$FIRM_NAME';
              const clean = name
                .replace(/[^a-zA-Z0-9\\s&]/g, '')
                .split(/\\s+/)
                .filter(w => w.length > 0)
                .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                .join('');
              console.log(clean || 'UnknownFirm');
            ")
            echo "Generated firm_folder: $FIRM_FOLDER"
          fi

          echo "firm_folder=$FIRM_FOLDER" >> $GITHUB_OUTPUT

          # Live URL (after moving from pending)
          LIVE_URL="https://reports.mortarmetrics.com/$FIRM_FOLDER/"
          echo "live_report_url=$LIVE_URL" >> $GITHUB_OUTPUT

          # Check if pending report exists
          if [ -f "pending-reports/$FIRM_FOLDER/index.html" ]; then
            echo "üìÇ Moving report from pending-reports/$FIRM_FOLDER to $FIRM_FOLDER (LIVE)"
            mkdir -p "$FIRM_FOLDER"
            mv "pending-reports/$FIRM_FOLDER/index.html" "$FIRM_FOLDER/index.html"
            rmdir "pending-reports/$FIRM_FOLDER" 2>/dev/null || true

            # Update approval status
            if [ -f "automation/pending-approvals/$FIRM_FOLDER.json" ]; then
              # Update status to approved
              node -e "
                const fs = require('fs');
                const file = 'automation/pending-approvals/$FIRM_FOLDER.json';
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                data.status = 'approved';
                data.approved_at = new Date().toISOString();
                fs.writeFileSync(file, JSON.stringify(data, null, 2));
              "
            fi
          else
            echo "‚ùå ERROR: No pending report found at pending-reports/$FIRM_FOLDER"
            echo "   Cannot proceed without report to deploy"
            # Check if live report exists already
            if [ -f "$FIRM_FOLDER/index.html" ]; then
              echo "   Live report already exists - continuing with email"
            else
              echo "   No live report either - aborting"
              exit 1
            fi
          fi

      - name: Commit and push live report
        run: |
          FIRM_FOLDER="${{ steps.deploy.outputs.firm_folder }}"
          git config user.name "Mortar Metrics Bot"
          git config user.email "automation@mortarmetrics.com"

          git add "$FIRM_FOLDER/" 2>/dev/null || true
          git add "automation/pending-approvals/$FIRM_FOLDER.json" 2>/dev/null || true
          git add "pending-reports/" 2>/dev/null || true
          git commit -m "Deploy approved report for $FIRM_FOLDER" || echo "No changes to commit"

          # Push with conflict-resilient retry
          git push origin main || {
            echo "Push failed, pulling latest and retrying..."
            cp "$FIRM_FOLDER/index.html" /tmp/live-report.html 2>/dev/null || true
            git reset HEAD~1
            git checkout -- . 2>/dev/null || true
            rm -rf "$FIRM_FOLDER/" 2>/dev/null || true
            git pull origin main
            if [ -f "$FIRM_FOLDER/index.html" ]; then
              echo "‚úÖ Report already deployed by parallel run ‚Äî nothing to do"
            else
              mkdir -p "$FIRM_FOLDER"
              cp /tmp/live-report.html "$FIRM_FOLDER/index.html"
              git add "$FIRM_FOLDER/" "automation/pending-approvals/" "pending-reports/" 2>/dev/null || true
              git diff --cached --quiet || {
                git commit -m "Deploy approved report for $FIRM_FOLDER"
                git push origin main || echo "‚ö†Ô∏è Push failed ‚Äî report may already exist"
              }
            fi
          }

      - name: Send approved email
        if: steps.inputs.outputs.skip_email != 'true'
        env:
          INSTANTLY_API_KEY: ${{ secrets.INSTANTLY_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC }}
          LEAD_EMAIL: ${{ steps.inputs.outputs.lead_email }}
          CONTACT_NAME: ${{ steps.inputs.outputs.contact_name }}
          FIRM_NAME: ${{ steps.inputs.outputs.firm_name }}
          TOTAL_RANGE: ${{ steps.inputs.outputs.total_range }}
          TOTAL_CASES: ${{ steps.inputs.outputs.total_cases }}
          PRACTICE_LABEL: ${{ steps.inputs.outputs.practice_label }}
          COUNTRY: ${{ steps.inputs.outputs.country }}
        run: |
          LIVE_URL="${{ steps.deploy.outputs.live_report_url }}"
          echo "üìß Sending approved email to $LEAD_EMAIL"
          echo "üè¢ Firm: $FIRM_NAME"
          echo "üîó Report: $LIVE_URL"
          echo "üìä Range: $TOTAL_RANGE | Cases: $TOTAL_CASES | Practice: $PRACTICE_LABEL"
          echo "üåç Country: $COUNTRY"

          node send-email.js \
            "$LEAD_EMAIL" \
            "$CONTACT_NAME" \
            "$LIVE_URL" \
            "" \
            "$FIRM_NAME" \
            "" \
            "$TOTAL_RANGE" \
            "$TOTAL_CASES" \
            "$PRACTICE_LABEL" \
            "$COUNTRY"
        working-directory: ./automation
