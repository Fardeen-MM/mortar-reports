name: Approve and Send Email

on:
  workflow_dispatch:
    inputs:
      firm_name:
        description: 'Firm Name'
        required: true
      lead_email:
        description: 'Lead Email'
        required: true
      report_url:
        description: 'Report URL'
        required: true
      email_id:
        description: 'Instantly Email ID (for threading)'
        required: false
      contact_name:
        description: 'Contact Name'
        required: true
      from_email:
        description: 'From Email (sending account)'
        required: false
        default: 'fardeen@mortarmetrics.com'
  repository_dispatch:
    types: [send_approved_email]

jobs:
  send-approved-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        working-directory: ./automation
        
      - name: Extract inputs
        id: inputs
        run: |
          # Handle both workflow_dispatch and repository_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "firm_name=${{ github.event.inputs.firm_name }}" >> $GITHUB_OUTPUT
            echo "lead_email=${{ github.event.inputs.lead_email }}" >> $GITHUB_OUTPUT
            echo "contact_name=${{ github.event.inputs.contact_name }}" >> $GITHUB_OUTPUT
            echo "report_url=${{ github.event.inputs.report_url }}" >> $GITHUB_OUTPUT
            echo "email_id=${{ github.event.inputs.email_id }}" >> $GITHUB_OUTPUT
            echo "from_email=${{ github.event.inputs.from_email }}" >> $GITHUB_OUTPUT
          else
            # repository_dispatch (from Telegram)
            echo "firm_name=${{ github.event.client_payload.firm_name }}" >> $GITHUB_OUTPUT
            echo "lead_email=${{ github.event.client_payload.lead_email }}" >> $GITHUB_OUTPUT
            echo "contact_name=${{ github.event.client_payload.contact_name }}" >> $GITHUB_OUTPUT
            echo "report_url=${{ github.event.client_payload.report_url }}" >> $GITHUB_OUTPUT
            echo "email_id=${{ github.event.client_payload.email_id }}" >> $GITHUB_OUTPUT
            echo "from_email=${{ github.event.client_payload.from_email }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Send approved email
        env:
          INSTANTLY_API_KEY: ${{ secrets.INSTANTLY_API_KEY }}
        run: |
          echo "ğŸ“§ Sending approved email to ${{ steps.inputs.outputs.lead_email }}"
          echo "ğŸ¢ Firm: ${{ steps.inputs.outputs.firm_name }}"
          echo "ğŸ“¨ From: ${{ steps.inputs.outputs.from_email }}"
          echo "ğŸ”— Report: ${{ steps.inputs.outputs.report_url }}"
          
          node send-email.js \
            "${{ steps.inputs.outputs.lead_email }}" \
            "${{ steps.inputs.outputs.contact_name }}" \
            "${{ steps.inputs.outputs.report_url }}" \
            "${{ steps.inputs.outputs.email_id }}" \
            "${{ steps.inputs.outputs.firm_name }}" \
            "${{ steps.inputs.outputs.from_email }}"
        working-directory: ./automation
