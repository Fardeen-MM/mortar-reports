name: Approve and Send Email

on:
  workflow_dispatch:
    inputs:
      firm_name:
        description: 'Firm Name'
        required: true
      lead_email:
        description: 'Lead Email'
        required: true
      report_url:
        description: 'Report URL'
        required: true
      email_id:
        description: 'Instantly Email ID (for threading)'
        required: false
      contact_name:
        description: 'Contact Name'
        required: true
      from_email:
        description: 'From Email (sending account)'
        required: false
        default: 'fardeen@mortarmetrics.com'
  repository_dispatch:
    types: [send_approved_email]

jobs:
  send-approved-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        working-directory: ./automation
        
      - name: Extract inputs
        id: inputs
        env:
          EVENT_NAME: ${{ github.event_name }}
          # workflow_dispatch inputs
          WD_FIRM_NAME: ${{ github.event.inputs.firm_name }}
          WD_LEAD_EMAIL: ${{ github.event.inputs.lead_email }}
          WD_CONTACT_NAME: ${{ github.event.inputs.contact_name }}
          WD_REPORT_URL: ${{ github.event.inputs.report_url }}
          WD_EMAIL_ID: ${{ github.event.inputs.email_id }}
          WD_FROM_EMAIL: ${{ github.event.inputs.from_email }}
          # repository_dispatch payload
          RD_FIRM_NAME: ${{ github.event.client_payload.firm_name }}
          RD_FIRM_FOLDER: ${{ github.event.client_payload.firm_folder }}
          RD_LEAD_EMAIL: ${{ github.event.client_payload.lead_email }}
          RD_CONTACT_NAME: ${{ github.event.client_payload.contact_name }}
          RD_REPORT_URL: ${{ github.event.client_payload.report_url }}
          RD_EMAIL_ID: ${{ github.event.client_payload.email_id }}
          RD_FROM_EMAIL: ${{ github.event.client_payload.from_email }}
        run: |
          # Handle both workflow_dispatch and repository_dispatch
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "firm_name=$WD_FIRM_NAME" >> $GITHUB_OUTPUT
            echo "lead_email=$WD_LEAD_EMAIL" >> $GITHUB_OUTPUT
            echo "contact_name=$WD_CONTACT_NAME" >> $GITHUB_OUTPUT
            echo "report_url=$WD_REPORT_URL" >> $GITHUB_OUTPUT
            echo "email_id=$WD_EMAIL_ID" >> $GITHUB_OUTPUT
            echo "from_email=$WD_FROM_EMAIL" >> $GITHUB_OUTPUT
            echo "firm_folder=" >> $GITHUB_OUTPUT
          else
            # repository_dispatch (from Telegram webhook)
            echo "firm_name=$RD_FIRM_NAME" >> $GITHUB_OUTPUT
            echo "firm_folder=$RD_FIRM_FOLDER" >> $GITHUB_OUTPUT
            echo "lead_email=$RD_LEAD_EMAIL" >> $GITHUB_OUTPUT
            echo "contact_name=$RD_CONTACT_NAME" >> $GITHUB_OUTPUT
            echo "report_url=$RD_REPORT_URL" >> $GITHUB_OUTPUT
            echo "email_id=$RD_EMAIL_ID" >> $GITHUB_OUTPUT
            echo "from_email=$RD_FROM_EMAIL" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy report from pending to live
        id: deploy
        run: |
          FIRM_NAME="${{ steps.inputs.outputs.firm_name }}"
          INPUT_FIRM_FOLDER="${{ steps.inputs.outputs.firm_folder }}"

          # Use firm_folder if provided, otherwise generate from firm name
          if [ -n "$INPUT_FIRM_FOLDER" ]; then
            FIRM_FOLDER="$INPUT_FIRM_FOLDER"
            echo "Using provided firm_folder: $FIRM_FOLDER"
          else
            # Generate folder name from firm name (same logic as process workflow)
            FIRM_FOLDER=$(node -e "
              const name = '$FIRM_NAME';
              const clean = name
                .replace(/[^a-zA-Z0-9\\s&]/g, '')
                .split(/\\s+/)
                .filter(w => w.length > 0)
                .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                .join('');
              console.log(clean || 'UnknownFirm');
            ")
            echo "Generated firm_folder: $FIRM_FOLDER"
          fi

          echo "firm_folder=$FIRM_FOLDER" >> $GITHUB_OUTPUT

          # Live URL (after moving from pending)
          LIVE_URL="https://reports.mortarmetrics.com/$FIRM_FOLDER/"
          echo "live_report_url=$LIVE_URL" >> $GITHUB_OUTPUT

          # Check if pending report exists
          if [ -f "pending-reports/$FIRM_FOLDER/index.html" ]; then
            echo "ğŸ“‚ Moving report from pending-reports/$FIRM_FOLDER to $FIRM_FOLDER (LIVE)"
            mkdir -p "$FIRM_FOLDER"
            mv "pending-reports/$FIRM_FOLDER/index.html" "$FIRM_FOLDER/index.html"
            rmdir "pending-reports/$FIRM_FOLDER" 2>/dev/null || true

            # Update approval status
            if [ -f "automation/pending-approvals/$FIRM_FOLDER.json" ]; then
              # Update status to approved
              node -e "
                const fs = require('fs');
                const file = 'automation/pending-approvals/$FIRM_FOLDER.json';
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                data.status = 'approved';
                data.approved_at = new Date().toISOString();
                fs.writeFileSync(file, JSON.stringify(data, null, 2));
              "
            fi
          else
            echo "âŒ ERROR: No pending report found at pending-reports/$FIRM_FOLDER"
            echo "   Cannot proceed without report to deploy"
            # Check if live report exists already
            if [ -f "$FIRM_FOLDER/index.html" ]; then
              echo "   Live report already exists - continuing with email"
            else
              echo "   No live report either - aborting"
              exit 1
            fi
          fi

      - name: Commit and push live report
        run: |
          FIRM_FOLDER="${{ steps.deploy.outputs.firm_folder }}"
          git config user.name "Mortar Metrics Bot"
          git config user.email "automation@mortarmetrics.com"

          git add "$FIRM_FOLDER/" 2>/dev/null || true
          git add "automation/pending-approvals/$FIRM_FOLDER.json" 2>/dev/null || true
          git add "pending-reports/" 2>/dev/null || true
          git commit -m "Deploy approved report for $FIRM_FOLDER" || echo "No changes to commit"

          # Push with conflict-resilient retry
          git push origin main || {
            echo "Push failed, pulling latest and retrying..."
            git reset --soft HEAD~1
            git reset HEAD .
            git pull origin main
            git add "$FIRM_FOLDER/" 2>/dev/null || true
            git add "automation/pending-approvals/$FIRM_FOLDER.json" 2>/dev/null || true
            git add "pending-reports/" 2>/dev/null || true
            if git diff --cached --quiet; then
              echo "âœ… No changes needed â€” files already exist on remote"
            else
              git commit -m "Deploy approved report for $FIRM_FOLDER"
              git push origin main || echo "âš ï¸ Push failed â€” report may already exist from parallel run"
            fi
          }

      - name: Send approved email
        env:
          INSTANTLY_API_KEY: ${{ secrets.INSTANTLY_API_KEY }}
        run: |
          LIVE_URL="${{ steps.deploy.outputs.live_report_url }}"
          echo "ğŸ“§ Sending approved email to ${{ steps.inputs.outputs.lead_email }}"
          echo "ğŸ¢ Firm: ${{ steps.inputs.outputs.firm_name }}"
          echo "ğŸ“¨ From: ${{ steps.inputs.outputs.from_email }}"
          echo "ğŸ”— Report: $LIVE_URL"

          node send-email.js \
            "${{ steps.inputs.outputs.lead_email }}" \
            "${{ steps.inputs.outputs.contact_name }}" \
            "$LIVE_URL" \
            "${{ steps.inputs.outputs.email_id }}" \
            "${{ steps.inputs.outputs.firm_name }}" \
            "${{ steps.inputs.outputs.from_email }}"
        working-directory: ./automation
